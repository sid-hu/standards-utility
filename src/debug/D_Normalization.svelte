<script lang="ts">
  import { constructMeasures } from "../common/boxes";
  import { Page as PBPage } from "../proto/local/data_pb";
  import { Page as PageWrapper } from "../types/data";
  import { Box } from "../types/generic";
  import type { Box as PBBox } from "../proto/local/generic_pb";

  import Page from "../components/Page.svelte";
  import PageBoxes from "../components/PageBoxes.svelte";
  import Loader from "../Loader.svelte";
  import Panel from "../components/Panel.svelte";

  let page = new PBPage();
  let image: Uint8Array;

  let threshold = 0.4;

  const boxes: {
    box: PBBox.AsObject;
    score: number;
  }[] = [
    {
      box: {
        x1: 0.7157540917396545,
        y1: 0.8401906490325928,
        x2: 0.8634533286094666,
        y2: 0.9405722618103027,
      },
      score: 0.9945506453514099,
    },
    {
      box: {
        x1: 0.6094110012054443,
        y1: 0.8396631479263306,
        x2: 0.7190124988555908,
        y2: 0.9414514303207397,
      },
      score: 0.9894214868545532,
    },
    {
      box: {
        x1: 0.35949844121932983,
        y1: 0.8407479524612427,
        x2: 0.5120176672935486,
        y2: 0.9420973062515259,
      },
      score: 0.9873554706573486,
    },
    {
      box: {
        x1: 0.5074000954627991,
        y1: 0.8400580883026123,
        x2: 0.6078928112983704,
        y2: 0.9416084289550781,
      },
      score: 0.9823662638664246,
    },
    {
      box: {
        x1: 0.03710734099149704,
        y1: 0.8414892554283142,
        x2: 0.2632709741592407,
        y2: 0.9424076676368713,
      },
      score: 0.9795258045196533,
    },
    {
      box: {
        x1: 0.5639435052871704,
        y1: 0.37252771854400635,
        x2: 0.6842676401138306,
        y2: 0.46327006816864014,
      },
      score: 0.9735238552093506,
    },
    {
      box: {
        x1: 0.3070295453071594,
        y1: 0.5160016417503357,
        x2: 0.4391849637031555,
        y2: 0.6173850893974304,
      },
      score: 0.9673831462860107,
    },
    {
      box: {
        x1: 0.3074577748775482,
        y1: 0.3731994032859802,
        x2: 0.4419006407260895,
        y2: 0.46343618631362915,
      },
      score: 0.9592365622520447,
    },
    {
      box: {
        x1: 0.04010341316461563,
        y1: 0.6830389499664307,
        x2: 0.23724594712257385,
        y2: 0.7830014228820801,
      },
      score: 0.957216739654541,
    },
    {
      box: {
        x1: 0.4360847771167755,
        y1: 0.3722470998764038,
        x2: 0.5597224831581116,
        y2: 0.46320295333862305,
      },
      score: 0.953126072883606,
    },
    {
      box: {
        x1: 0.6253892183303833,
        y1: 0.5165662169456482,
        x2: 0.7274254560470581,
        y2: 0.6167094111442566,
      },
      score: 0.9522311687469482,
    },
    {
      box: {
        x1: 0.04129474610090256,
        y1: 0.5169622302055359,
        x2: 0.20763063430786133,
        y2: 0.6177929043769836,
      },
      score: 0.949700653553009,
    },
    {
      box: {
        x1: 0.03755620867013931,
        y1: 0.3734930455684662,
        x2: 0.21702340245246887,
        y2: 0.46329161524772644,
      },
      score: 0.9444680213928223,
    },
    {
      box: {
        x1: 0.10512368381023407,
        y1: 0.22152821719646454,
        x2: 0.2582021951675415,
        y2: 0.3118782937526703,
      },
      score: 0.9442469477653503,
    },
    {
      box: {
        x1: 0.7287362813949585,
        y1: 0.5161548256874084,
        x2: 0.8233031034469604,
        y2: 0.617064893245697,
      },
      score: 0.9407481551170349,
    },
    {
      box: {
        x1: 0.3604307174682617,
        y1: 0.2203666865825653,
        x2: 0.522226095199585,
        y2: 0.31198063492774963,
      },
      score: 0.9407276511192322,
    },
    {
      box: {
        x1: 0.5847607851028442,
        y1: 0.6813367605209351,
        x2: 0.7092899084091187,
        y2: 0.7804725170135498,
      },
      score: 0.9402588605880737,
    },
    {
      box: {
        x1: 0.2635728120803833,
        y1: 0.8411118984222412,
        x2: 0.3569701910018921,
        y2: 0.9414799213409424,
      },
      score: 0.9384287595748901,
    },
    {
      box: {
        x1: 0.5273004174232483,
        y1: 0.2194107174873352,
        x2: 0.6445080637931824,
        y2: 0.3120418190956116,
      },
      score: 0.9340679049491882,
    },
    {
      box: {
        x1: 0.23951740562915802,
        y1: 0.680964469909668,
        x2: 0.35950905084609985,
        y2: 0.7835811376571655,
      },
      score: 0.9226574301719666,
    },
    {
      box: {
        x1: 0.254123330116272,
        y1: 0.2198597490787506,
        x2: 0.3662450313568115,
        y2: 0.3120482265949249,
      },
      score: 0.9217185974121094,
    },
    {
      box: {
        x1: 0.861461341381073,
        y1: 0.840820848941803,
        x2: 0.9295254349708557,
        y2: 0.9344174265861511,
      },
      score: 0.9073443412780762,
    },
    {
      box: {
        x1: 0.6409380435943604,
        y1: 0.22014223039150238,
        x2: 0.8224756717681885,
        y2: 0.3118017911911011,
      },
      score: 0.9003636837005615,
    },
    {
      box: {
        x1: 0.8089386820793152,
        y1: 0.6818737387657166,
        x2: 0.9339732527732849,
        y2: 0.7806224226951599,
      },
      score: 0.8994945883750916,
    },
    {
      box: {
        x1: 0.21856313943862915,
        y1: 0.3716408610343933,
        x2: 0.3059154152870178,
        y2: 0.46317780017852783,
      },
      score: 0.8906529545783997,
    },
    {
      box: {
        x1: 0.21522992849349976,
        y1: 0.5149683356285095,
        x2: 0.30555641651153564,
        y2: 0.6172477602958679,
      },
      score: 0.8873581290245056,
    },
    {
      box: {
        x1: 0.5259364247322083,
        y1: 0.514847993850708,
        x2: 0.6205350756645203,
        y2: 0.6164389848709106,
      },
      score: 0.8847141861915588,
    },
    {
      box: {
        x1: 0.8272243738174438,
        y1: 0.22277362644672394,
        x2: 0.9402743577957153,
        y2: 0.3129339814186096,
      },
      score: 0.8830709457397461,
    },
    {
      box: {
        x1: 0.7861706614494324,
        y1: 0.373820036649704,
        x2: 0.9294713139533997,
        y2: 0.46300986409187317,
      },
      score: 0.8825775384902954,
    },
    {
      box: {
        x1: 0.4736940562725067,
        y1: 0.6791274547576904,
        x2: 0.583289623260498,
        y2: 0.7802616357803345,
      },
      score: 0.8778366446495056,
    },
    {
      box: {
        x1: 0.43393999338150024,
        y1: 0.5145836472511292,
        x2: 0.5269333720207214,
        y2: 0.616532027721405,
      },
      score: 0.8717432618141174,
    },
    {
      box: {
        x1: 0.36311763525009155,
        y1: 0.6794355511665344,
        x2: 0.46795451641082764,
        y2: 0.781055748462677,
      },
      score: 0.8712816834449768,
    },
    {
      box: {
        x1: 0.689864993095398,
        y1: 0.3720351457595825,
        x2: 0.7831569910049438,
        y2: 0.4627227187156677,
      },
      score: 0.8612558841705322,
    },
    {
      box: {
        x1: 0.8246300220489502,
        y1: 0.515150249004364,
        x2: 0.9351747035980225,
        y2: 0.6166689991950989,
      },
      score: 0.8414180278778076,
    },
    {
      box: {
        x1: 0.7131535410881042,
        y1: 0.6803295016288757,
        x2: 0.8077287077903748,
        y2: 0.7801863551139832,
      },
      score: 0.8232753872871399,
    },
    {
      box: {
        x1: 0.5778049230575562,
        y1: 0.8380484580993652,
        x2: 0.6910935640335083,
        y2: 0.9418935775756836,
      },
      score: 0.3291226327419281,
    },
    {
      box: {
        x1: 0.7131484150886536,
        y1: 0.6067093014717102,
        x2: 0.8080779910087585,
        y2: 0.7756065726280212,
      },
      score: 0.23307886719703674,
    },
    {
      box: {
        x1: 0.7770843505859375,
        y1: 0.27804291248321533,
        x2: 0.9376348257064819,
        y2: 0.4605758786201477,
      },
      score: 0.16664978861808777,
    },
    {
      box: {
        x1: 0.8089955449104309,
        y1: 0.6179250478744507,
        x2: 0.9340044856071472,
        y2: 0.7758907079696655,
      },
      score: 0.15981175005435944,
    },
    {
      box: {
        x1: 0.5260270833969116,
        y1: 0.1580323576927185,
        x2: 0.6447848081588745,
        y2: 0.31080693006515503,
      },
      score: 0.15792661905288696,
    },
    {
      box: {
        x1: 0.82600337266922,
        y1: 0.16130098700523376,
        x2: 0.938476026058197,
        y2: 0.31377536058425903,
      },
      score: 0.15748214721679688,
    },
    {
      box: {
        x1: 0.21649911999702454,
        y1: 0.37813615798950195,
        x2: 0.3049295246601105,
        y2: 0.5379551649093628,
      },
      score: 0.14515654742717743,
    },
    {
      box: {
        x1: 0.8216806054115295,
        y1: 0.4258349537849426,
        x2: 0.9361862540245056,
        y2: 0.6171432137489319,
      },
      score: 0.13362719118595123,
    },
    {
      box: {
        x1: 0.716521680355072,
        y1: 0.5177799463272095,
        x2: 0.814395010471344,
        y2: 0.7955288887023926,
      },
      score: 0.12872755527496338,
    },
    {
      box: {
        x1: 0.6650534272193909,
        y1: 0.6838145852088928,
        x2: 0.7906352877616882,
        y2: 0.7828307747840881,
      },
      score: 0.12759774923324585,
    },
    {
      box: {
        x1: 0.4692752957344055,
        y1: 0.6134006977081299,
        x2: 0.5901431441307068,
        y2: 0.7769775390625,
      },
      score: 0.12683196365833282,
    },
    {
      box: {
        x1: 0.7270118594169617,
        y1: 0.519124448299408,
        x2: 0.8209124207496643,
        y2: 0.6805179715156555,
      },
      score: 0.12659747898578644,
    },
    {
      box: {
        x1: 0.4936882257461548,
        y1: 0.23549598455429077,
        x2: 0.9244996309280396,
        y2: 0.447966992855072,
      },
      score: 0.1222795769572258,
    },
    {
      box: {
        x1: 0.21203291416168213,
        y1: 0.43033936619758606,
        x2: 0.3060062527656555,
        y2: 0.6146864295005798,
      },
      score: 0.12063471227884293,
    },
    {
      box: {
        x1: 0.24673673510551453,
        y1: 0.14134541153907776,
        x2: 0.36063244938850403,
        y2: 0.3102310597896576,
      },
      score: 0.11251582205295563,
    },
    {
      box: {
        x1: 0.2741243839263916,
        y1: 0.3701964020729065,
        x2: 0.40191012620925903,
        y2: 0.46265745162963867,
      },
      score: 0.10756456851959229,
    },
    {
      box: {
        x1: 0.8239372372627258,
        y1: 0.22647136449813843,
        x2: 0.9371878504753113,
        y2: 0.38128674030303955,
      },
      score: 0.10413967072963715,
    },
    {
      box: {
        x1: 0.756868302822113,
        y1: 0.6836134195327759,
        x2: 0.8853811621665955,
        y2: 0.7829493284225464,
      },
      score: 0.10301700234413147,
    },
    {
      box: {
        x1: 0.11688582599163055,
        y1: 0.1531352698802948,
        x2: 0.2478320151567459,
        y2: 0.3084980249404907,
      },
      score: 0.09784064441919327,
    },
    {
      box: {
        x1: 0.3245137333869934,
        y1: 0.5375274419784546,
        x2: 0.7290694117546082,
        y2: 0.7492953538894653,
      },
      score: 0.09505877643823624,
    },
    {
      box: {
        x1: 0.275752454996109,
        y1: 0.5124499797821045,
        x2: 0.40426620841026306,
        y2: 0.6159974336624146,
      },
      score: 0.09466350823640823,
    },
    {
      box: {
        x1: 0.6424119472503662,
        y1: 0.22057156264781952,
        x2: 0.7337541580200195,
        y2: 0.31472325325012207,
      },
      score: 0.09396857023239136,
    },
    {
      box: {
        x1: 0.6122653484344482,
        y1: 0.3710714876651764,
        x2: 0.7412247657775879,
        y2: 0.4630248248577118,
      },
      score: 0.09106990694999695,
    },
    {
      box: {
        x1: 0.8145782351493835,
        y1: 0.5170592069625854,
        x2: 0.9383576512336731,
        y2: 0.7778686285018921,
      },
      score: 0.08932662010192871,
    },
    {
      box: {
        x1: 0.7361135482788086,
        y1: 0.2151641994714737,
        x2: 0.9232243299484253,
        y2: 0.4566826820373535,
      },
      score: 0.08821850270032883,
    },
    {
      box: {
        x1: 0.6906644105911255,
        y1: 0.3399980068206787,
        x2: 0.7988491058349609,
        y2: 0.4703565835952759,
      },
      score: 0.08642920851707458,
    },
    {
      box: {
        x1: 0.35869818925857544,
        y1: 0.5710785984992981,
        x2: 0.46833324432373047,
        y2: 0.7833020091056824,
      },
      score: 0.08431567251682281,
    },
    {
      box: {
        x1: 0.7486356496810913,
        y1: 0.37060579657554626,
        x2: 0.8883862495422363,
        y2: 0.4617842733860016,
      },
      score: 0.0838303342461586,
    },
    {
      box: {
        x1: 0.31617361307144165,
        y1: 0.29894834756851196,
        x2: 0.4378587007522583,
        y2: 0.4570619463920593,
      },
      score: 0.08116147667169571,
    },
    {
      box: {
        x1: 0.47337836027145386,
        y1: 0.8390307426452637,
        x2: 0.5897491574287415,
        y2: 0.9430875778198242,
      },
      score: 0.07935988903045654,
    },
    {
      box: {
        x1: 0.6564871072769165,
        y1: 0.2184748351573944,
        x2: 0.8548041582107544,
        y2: 0.4213227927684784,
      },
      score: 0.07867542654275894,
    },
    {
      box: {
        x1: 0.2123040109872818,
        y1: 0.3406602144241333,
        x2: 0.32135504484176636,
        y2: 0.4704326391220093,
      },
      score: 0.07797259837388992,
    },
    {
      box: {
        x1: 0.7339533567428589,
        y1: 0.3901677131652832,
        x2: 0.9219825267791748,
        y2: 0.7991901636123657,
      },
      score: 0.07794683426618576,
    },
    {
      box: {
        x1: 0.43439894914627075,
        y1: 0.29572296142578125,
        x2: 0.5574920773506165,
        y2: 0.46364009380340576,
      },
      score: 0.07722440361976624,
    },
    {
      box: {
        x1: 0.947507381439209,
        y1: 0.368264377117157,
        x2: 1,
        y2: 0.46321505308151245,
      },
      score: 0.07375574111938477,
    },
    {
      box: {
        x1: 0.7457004189491272,
        y1: 0.3748806118965149,
        x2: 0.9271089434623718,
        y2: 0.5722994208335876,
      },
      score: 0.07190462946891785,
    },
    {
      box: {
        x1: 0.6059098839759827,
        y1: 0.7822006940841675,
        x2: 0.7202031016349792,
        y2: 0.9384138584136963,
      },
      score: 0.07108800858259201,
    },
    {
      box: {
        x1: 0.7098071575164795,
        y1: 0.7333862781524658,
        x2: 0.8116631507873535,
        y2: 0.7781847715377808,
      },
      score: 0.07099123299121857,
    },
    {
      box: {
        x1: 0.740485429763794,
        y1: 0.24292579293251038,
        x2: 0.9305758476257324,
        y2: 0.5996004343032837,
      },
      score: 0.07031962275505066,
    },
    {
      box: {
        x1: 0.2964836359024048,
        y1: 0.21895664930343628,
        x2: 0.43279147148132324,
        y2: 0.3112696409225464,
      },
      score: 0.07019920647144318,
    },
    {
      box: {
        x1: 0.4351568818092346,
        y1: 0.42220446467399597,
        x2: 0.6140086054801941,
        y2: 0.7524217367172241,
      },
      score: 0.07007216662168503,
    },
    {
      box: {
        x1: 0.24608539044857025,
        y1: 0.3909480571746826,
        x2: 0.7440032958984375,
        y2: 0.5967302322387695,
      },
      score: 0.06962496042251587,
    },
    {
      box: {
        x1: 0.4371854364871979,
        y1: 0.37718692421913147,
        x2: 0.547393262386322,
        y2: 0.5395764112472534,
      },
      score: 0.06856916099786758,
    },
    {
      box: {
        x1: 0.8193959593772888,
        y1: 0.5202798843383789,
        x2: 0.9296897053718567,
        y2: 0.6908760070800781,
      },
      score: 0.06695674359798431,
    },
    {
      box: {
        x1: 0.5497856736183167,
        y1: 0.5224964618682861,
        x2: 0.7242533564567566,
        y2: 0.7398741245269775,
      },
      score: 0.06631701439619064,
    },
    {
      box: {
        x1: 0.32773205637931824,
        y1: 0.5141342282295227,
        x2: 0.43160703778266907,
        y2: 0.675381600856781,
      },
      score: 0.06610174477100372,
    },
    {
      box: {
        x1: 0.424965500831604,
        y1: 0.37789905071258545,
        x2: 0.6091688871383667,
        y2: 0.5702167749404907,
      },
      score: 0.06527489423751831,
    },
    {
      box: {
        x1: 0.47139033675193787,
        y1: 0.3900846242904663,
        x2: 1,
        y2: 0.5970652103424072,
      },
      score: 0.06491642445325851,
    },
    {
      box: {
        x1: 0.4313214123249054,
        y1: 0.435882031917572,
        x2: 0.530884861946106,
        y2: 0.6148712038993835,
      },
      score: 0.06474369019269943,
    },
    {
      box: {
        x1: 0.36643534898757935,
        y1: 0.14367640018463135,
        x2: 0.517747700214386,
        y2: 0.3083917796611786,
      },
      score: 0.06458353251218796,
    },
    {
      box: {
        x1: 0.11070287227630615,
        y1: 0.5407577157020569,
        x2: 0.5209572911262512,
        y2: 0.7486228346824646,
      },
      score: 0.06335414201021194,
    },
    {
      box: {
        x1: 0.31742459535598755,
        y1: 0.3649638891220093,
        x2: 0.5150207877159119,
        y2: 0.4737006425857544,
      },
      score: 0.06311138719320297,
    },
    {
      box: {
        x1: 0.35979676246643066,
        y1: 0.7358251214027405,
        x2: 0.47160279750823975,
        y2: 0.778803288936615,
      },
      score: 0.06281306594610214,
    },
    {
      box: {
        x1: 0.7581355571746826,
        y1: 0.513129472732544,
        x2: 0.911126971244812,
        y2: 0.743990421295166,
      },
      score: 0.06231824308633804,
    },
    {
      box: {
        x1: 0.8057346343994141,
        y1: 0.22071580588817596,
        x2: 0.9379453659057617,
        y2: 0.44297635555267334,
      },
      score: 0.061992891132831573,
    },
    {
      box: {
        x1: 0.729354739189148,
        y1: 0.22094005346298218,
        x2: 0.825931191444397,
        y2: 0.3171418309211731,
      },
      score: 0.06193391606211662,
    },
    {
      box: {
        x1: 0.46784064173698425,
        y1: 0.5240793228149414,
        x2: 0.6628267168998718,
        y2: 0.7226014137268066,
      },
      score: 0.06176542863249779,
    },
    {
      box: {
        x1: 0.21795548498630524,
        y1: 0.5878206491470337,
        x2: 0.30652302503585815,
        y2: 0.6186949014663696,
      },
      score: 0.060932815074920654,
    },
    {
      box: {
        x1: 0.3599501848220825,
        y1: 0.3712313175201416,
        x2: 0.4975154399871826,
        y2: 0.4631219506263733,
      },
      score: 0.06039224937558174,
    },
    {
      box: {
        x1: 0.5148470997810364,
        y1: 0.5176676511764526,
        x2: 0.6148368716239929,
        y2: 0.67401123046875,
      },
      score: 0.05980914086103439,
    },
    {
      box: {
        x1: 0.5054963827133179,
        y1: 0.36990243196487427,
        x2: 0.6416789293289185,
        y2: 0.4628326892852783,
      },
      score: 0.05834859982132912,
    },
    {
      box: {
        x1: 0.7864735126495361,
        y1: 0.37127554416656494,
        x2: 0.8563976287841797,
        y2: 0.46497273445129395,
      },
      score: 0.05792256444692612,
    },
    {
      box: {
        x1: 0.7171778678894043,
        y1: 0.7495737075805664,
        x2: 0.8082680702209473,
        y2: 0.7806892395019531,
      },
      score: 0.05769097059965134,
    },
    {
      box: {
        x1: 0.5612357258796692,
        y1: 0.29736506938934326,
        x2: 0.6798718571662903,
        y2: 0.4620993137359619,
      },
      score: 0.05758616328239441,
    },
    {
      box: {
        x1: 0.44158169627189636,
        y1: 0.5872704386711121,
        x2: 0.5275081396102905,
        y2: 0.6188545823097229,
      },
      score: 0.056664783507585526,
    },
  ];

  const makeMeasures = (threshold: number) => {
    return constructMeasures(
      boxes
        .filter((o) => o.score > threshold)
        .map((o) => {
          return {
            box: new Box({
              x1: o.box.x1,
              x2: o.box.x2,
              y1: o.box.y1,
              y2: o.box.y2,
            }),
            score: o.score,
          };
        }),
      { threshold: threshold, lineMargin: 0.02 }
    );
  };

  const promise = (async function () {
    const r = await window.fetch(`${window.location.origin}/examples/1.png`);
    image = new Uint8Array(await r.arrayBuffer());
    page.setImage(new Uint8Array(image));
    page.setMeasures(makeMeasures(threshold));
  })();
</script>

<div class="w-full h-full">
  <Panel rounded="rounded-lg" className="fixed top-8 left-8 px-5 py-3">
    <h1 class="text-lg font-semibold">threshold</h1>
    <input
      type="range"
      min={0}
      step={0.01}
      max={1}
      value={threshold}
      on:input={(e) => {
        threshold = parseFloat(e.currentTarget.value);
        page = new PageWrapper({
          ...page.toObject(),
          measures: makeMeasures(threshold).toObject(),
        });
      }}
    />
  </Panel>
  <Loader {promise} let:loaded>
    {#if loaded}
      <Page {page} alt="page 1" />
      <PageBoxes
        image={page.getImage_asU8()}
        boxes={boxes
          .filter((b) => b.score > threshold)
          .map((b) => {
            return new Box({
              x1: b.box.x1,
              x2: b.box.x2,
              y1: b.box.y1,
              y2: b.box.y2,
            });
          })}
        alt="page 1"
      />
    {/if}
  </Loader>
</div>
